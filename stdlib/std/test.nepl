#indent 4

#import "std/math" as *
#import "std/mem" as *
#import "std/result" as *

// test: 標準ライブラリ用の簡易テスト支援
//
// 目的:
// - assert 系関数と、文字列比較を提供します。
//
// 実装(アルゴリズム):
// - 失敗時は trap で異常終了させます。
//
// 注意(重要):
// - 失敗は回復不能です。テスト用途に限定してください。
//
// 計算量:
// - 文字列比較は O(n)、その他は O(1)

// test_str_eq: 文字列が等しいか判定する
//
// 目的:
// - a と b の内容が同じなら true を返します。
//
// 実装(アルゴリズム):
// - 長さ一致を確認し、バイト単位で比較します。
//
// 注意(重要):
// - UTF-8 のバイト列として比較します。
//
// 計算量:
// - O(n)
fn test_str_eq <(str,str)->bool> (a,b):
    let la <i32> load_i32 a;
    let lb <i32> load_i32 b;
    if:
        eq la lb
        then:
            test_str_eq_loop a b la 0
        else:
            false

// test_str_eq_loop: 文字列比較の内部ループ
//
// 目的:
// - i を進めながら各バイトを比較します。
//
// 実装(アルゴリズム):
// - 一致なら再帰、差異があれば false を返します。
//
// 注意(重要):
// - 呼び出し側で長さ一致を確認している前提です。
//
// 計算量:
// - O(n)
fn test_str_eq_loop <(str,str,i32,i32)->bool> (a,b,len,i):
    if:
        eq i len
        then:
            true
        else:
            let ba <i32> load_u8 add a add 4 i;
            let bb <i32> load_u8 add b add 4 i;
            if:
                eq ba bb
                then test_str_eq_loop a b len add i 1
                else false

// trap: 異常終了させる
//
// 目的:
// - 失敗を即座に検出するため異常終了します。
//
// 実装(アルゴリズム):
// - 0 除算で trap させます。
//
// 注意(重要):
// - 正常なプログラムでは使わないでください。
//
// 計算量:
// - O(1)
fn trap <()->()> ():
    #wasm:
        i32.const 1
        i32.const 0
        i32.div_s
        drop

// fail: unreachable に到達する
//
// 目的:
// - 失敗時の到達不能箇所として使います。
//
// 実装(アルゴリズム):
// - wasm の unreachable を呼びます。
//
// 注意(重要):
// - 呼び出すと即座に異常終了します。
//
// 計算量:
// - O(1)
fn fail <(str)->()> (msg):
    #wasm:
        unreachable

// assert: 条件が false のとき失敗する
//
// 目的:
// - ok が false なら trap します。
//
// 実装(アルゴリズム):
// - if で分岐し、false なら trap します。
//
// 注意(重要):
// - ok は bool である必要があります。
//
// 計算量:
// - O(1)
fn assert <(bool)->()> (ok):
    if:
        ok
        then ()
        else:
            trap;

// assert_eq_i32: i32 の等値を検証する
//
// 目的:
// - expected と actual が等しいことを保証します。
//
// 実装(アルゴリズム):
// - eq の結果が false なら trap します。
//
// 注意(重要):
// - i32 専用です。
//
// 計算量:
// - O(1)
fn assert_eq_i32 <(i32,i32)->()> (expected, actual):
    if:
        eq expected actual
        then ()
        else:
            trap;

// assert_ne: bool が等しくないことを検証する
//
// 目的:
// - a と b が同じなら trap します。
//
// 実装(アルゴリズム):
// - a の値で分岐し、b との一致を確認します。
//
// 注意(重要):
// - bool 専用です。
//
// 計算量:
// - O(1)
fn assert_ne <(bool,bool)->()> (a, b):
    if:
        a
        then:
            if:
                b
                then:
                    trap;
                else ()
        else:
            if:
                b
                then ()
                else:
                    trap;

// assert_str_eq: 文字列が等しいことを検証する
//
// 目的:
// - expected と actual が同じであることを保証します。
//
// 実装(アルゴリズム):
// - test_str_eq で比較し、false なら trap します。
//
// 注意(重要):
// - UTF-8 のバイト列として比較します。
//
// 計算量:
// - O(n)
fn assert_str_eq <(str,str)->()> (expected, actual):
    if:
        test_str_eq expected actual
        then ()
        else:
            trap;

// assert_ok_i32: Result が Ok であることを検証する
//
// 目的:
// - Result::Ok を受け付け、Err なら trap します。
//
// 実装(アルゴリズム):
// - match で Ok/Err を分岐します。
//
// 注意(重要):
// - Result<i32,i32> 専用です。
//
// 計算量:
// - O(1)
fn assert_ok_i32 <(Result<i32,i32>)->()> (r):
    match r:
        Result::Ok v:
            ()
        Result::Err e:
            trap;

// assert_err_i32: Result が Err であることを検証する
//
// 目的:
// - Result::Err を受け付け、Ok なら trap します。
//
// 実装(アルゴリズム):
// - match で Ok/Err を分岐します。
//
// 注意(重要):
// - Result<i32,i32> 専用です。
//
// 計算量:
// - O(1)
fn assert_err_i32 <(Result<i32,i32>)->()> (r):
    match r:
        Result::Ok v:
            trap;
        Result::Err e:
            ()
