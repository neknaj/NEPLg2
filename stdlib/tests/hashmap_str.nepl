//: hashmap_str: tests/hashmap_str.nepl に関する機能を提供するライブラリ
//:
//: [目的/もくてき]:
//: - このモジュールの公開 API を提供します。
//: - 実装の変更時に最小限の doctest 実行経路を維持します。
//:
//: [注意/ちゅうい]:
//: - 詳細な関数別ドキュメントは段階的に追記します。
//:
//: neplg2:test[skip]
//: ```neplg2
//:| #entry main
//:| #target wasi
//: ()
//: ```

#entry main
#indent 4
#target wasi

#import "alloc/collections/hashmap_str" as *
#import "alloc/string" as *
#import "core/option" as *
#import "std/test" as *

//: main: 関数の概要
//:
//: [目的/もくてき]:
//: - main が担う機能を提供します。
//:
//: [実装/じっそう]:
//: - 前置記法・オフサイドルール前提で読みやすく保つ構造です。
//:
//: [注意/ちゅうい]:
//: - 型引数や所有権の制約は呼び出し側で満たしてください。
//:
//: [計算量/けいさんりょう]:
//: - 実装に依存します。
fn main <()*> ()> ():
    let hm <i32> hashmap_str_new<i32>
    assert_eq_i32 0 hashmap_str_len<i32> hm
    assert_ne true hashmap_str_contains<i32> hm "foo"
    assert is_none<i32> hashmap_str_get<i32> hm "foo"
    test_checked "new"

    hashmap_str_insert<i32> hm "foo" 10
    hashmap_str_insert<i32> hm "bar" 20
    assert_eq_i32 2 hashmap_str_len<i32> hm
    assert hashmap_str_contains<i32> hm "foo"
    assert hashmap_str_contains<i32> hm "bar"
    assert_ne true hashmap_str_contains<i32> hm "baz"
    test_checked "insert"

    let s1 <str> concat "a" "b"
    let s2 <str> concat "a" "b"
    hashmap_str_insert<i32> hm s1 30
    match hashmap_str_get<i32> hm s2:
        Option::Some v:
            assert_eq_i32 30 v
        Option::None:
            test_fail "hashmap_str_get with same content returned None"
    test_checked "content"

    hashmap_str_insert<i32> hm "foo" 11
    match hashmap_str_get<i32> hm "foo":
        Option::Some v:
            assert_eq_i32 11 v
        Option::None:
            test_fail "hashmap_str_get foo after update returned None"
    test_checked "update"

    match hashmap_str_remove<i32> hm "bar":
        Option::Some v:
            assert_eq_i32 20 v
        Option::None:
            test_fail "hashmap_str_remove bar returned None"
    assert_ne true hashmap_str_contains<i32> hm "bar"
    assert is_none<i32> hashmap_str_remove<i32> hm "zzz"
    test_checked "remove"

    hashmap_str_free<i32> hm
    ()
